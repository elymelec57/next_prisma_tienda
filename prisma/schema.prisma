// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// La clave 'id' es el campo polimórfico
model Image {
  id         String   @id @default(cuid())
  url        String // URL del servicio de almacenamiento (Vercel Blob/S3/Cloudinary)
  altText    String? // Texto alternativo para accesibilidad
  uploadedAt DateTime @default(now())

  // --- Campos Polimórficos ---
  // 1. Clave Foránea al Modelo 'Padre'
  modelId String

  // 2. Tipo del Modelo 'Padre'
  modelType String

  // Índices para mejorar el rendimiento de búsqueda
  @@index([modelId, modelType])
}

model User {
  id          Int         @id @default(autoincrement())
  email       String      @unique
  name        String
  password    String
  roles       RolUser[]
  empleados   Empleado[]
  business    Restaurant?
  // Campo para almacenar el ID de la Imagen Principal.
  // La imagen se gestiona a través de la relación polimórfica en la capa de la aplicación.
  mainImageId String?
}

model RolUser {
  id        Int      @id @default(autoincrement())
  name      String
  users     User[]
  createdAt DateTime @default(now())
}

model Restaurant {
  id                     Int                      @id @default(autoincrement())
  slug                   String
  name                   String
  slogan                 String
  phone                  String
  direcction             String
  user                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId                 Int                      @unique // relation scalar field (used in the `@relation` attribute above)
  cliente                Cliente[]
  pedidos                Pedido[]
  platos                 Plato[]
  ingredienteRestaurante IngredienteRestaurante[]
  categoriaRestaurant    CategoriaRestaurant[]
  paymentMethods         PaymentMethod[]

  // Campo para almacenar el ID de la Imagen Principal.
  // La imagen se gestiona a través de la relación polimórfica en la capa de la aplicación.
  mainImageId     String?
  contornos       Contornos[]
  restaurantHours RestaurantHours?
  payments        Payment[]
  employees       Empleado[]
  mesas Mesa[]
}

model RestaurantHours {
  id           Int        @id @default(autoincrement())
  dayOfWeek    Int // 0 (Domingo) a 6 (Sábado)
  openTime     String // "09:00"
  closeTime    String // "22:00"
  isOpen       Boolean    @default(true)
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  restaurantId Int        @unique // relation scalar field (used in the `@relation` attribute above)
}

// --- Entidades del Menú y Platos ---

model Categoria {
  id     Int     @id @default(autoincrement())
  nombre String  @unique
  platos Plato[] // Relación: Una categoría tiene muchos platos
}

model CategoriaIngrediente {
  id           Int           @id @default(autoincrement())
  nombre       String        @unique
  ingredientes Ingrediente[]
}

model CategoriaRestaurant {
  id           Int          @id @default(autoincrement())
  nombre       String       @unique
  restaurantes Restaurant[]
}

model Plato {
  id           Int          @id @default(autoincrement())
  nombre       String
  descripcion  String?
  precio       Float
  disponible   Boolean      @default(true)
  categoriaId  Int
  categoria    Categoria    @relation(fields: [categoriaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  restaurantId Int
  restaurant   Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  itemsPedido  ItemPedido[] // Relación: Un plato puede estar en muchos items de pedido
  contornos    Contornos[]
  // Campo para almacenar el ID de la Imagen Principal.
  // La imagen se gestiona a través de la relación polimórfica en la capa de la aplicación.
  mainImageId  String?
}

model Ingrediente {
  id                      Int                      @id @default(autoincrement())
  nombre                  String
  categoriaIngredienteId  Int
  categoriaIngrediente    CategoriaIngrediente     @relation(fields: [categoriaIngredienteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  ingredienteRestaurantes IngredienteRestaurante[]
}

model IngredienteRestaurante {
  id  Int     @id @default(autoincrement())
  sku String? @unique

  // Inventario
  unidadMedida String // "kg", "lt", "oz", "unidad"
  stockActual  Float  @default(0)
  stockMinimo  Float  @default(0)
  stockMaximo  Float?

  // Costos
  costoUnitario Decimal @db.Decimal(10, 2)

  ingredienteId Int
  ingrediente   Ingrediente @relation(fields: [ingredienteId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Fechas y Control
  fechaVencimiento DateTime?
  ultimoIngreso    DateTime  @default(now())

  // // Relaciones (Opcional) 
  // proveedorId     String?
  // proveedor       Proveedor? @relation(fields: [proveedorId], references: [id])
  restaurant Restaurant[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

// model Proveedor {
//   id          String        @id @default(uuid())
//   nombre      String
//   contacto    String?
//   ingredientes Ingrediente[]
// }

model Contornos {
  id           Int        @id @default(autoincrement())
  nombre       String
  price        Float?
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  platos       Plato[]
}

// --- Entidades de Mesas y Clientes ---

model Mesa {
  id        Int       @id @default(autoincrement())
  numero    Int
  capacidad Int
  estado    String    @default("Libre") // Ej: "Libre", "Ocupada", "Reservada"
  qrData    Json?
  pedidos   Pedido[] // Relación: Una mesa puede tener muchos pedidos a lo largo del tiempo
  reservas  Reserva[] // Relación: Una mesa puede tener muchas reservas
  restaurantId Int // El pedido tambien pertenece a un restaurante
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Cliente {
  id         Int          @id @default(autoincrement())
  nombre     String
  telefono   String?      @unique
  email      String?      @unique
  pedidos    Pedido[] // Relación: Un cliente puede realizar muchos pedidos
  reservas   Reserva[] // Relación: Un cliente puede realizar muchas reservas
  restaurant Restaurant[]

  // Campo para almacenar el ID de la Imagen Principal.
  // La imagen se gestiona a través de la relación polimórfica en la capa de la aplicación.
  mainImageId String?
}

// --- Entidades de Pedidos ---

model Pedido {
  id           Int          @id @default(autoincrement())
  fechaHora    DateTime     @default(now())
  estado       String       @default("Pendiente") // Ej: "Pendiente", "Preparando", "Servido", "Pagado", "Cancelado"
  total        Float        @default(0.0)
  clienteId    Int? // El pedido puede ser de un cliente registrado o no
  cliente      Cliente?     @relation(fields: [clienteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  restaurantId Int? // El pedido tambien pertenece a un restaurante
  restaurant   Restaurant?  @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  mesaId       Int
  mesa         Mesa         @relation(fields: [mesaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  empleadoId   Int? // Quién tomó el pedido (opcional)
  empleado     Empleado?    @relation(fields: [empleadoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  items        ItemPedido[] // Relación: Un pedido tiene muchos items
  Payment      Payment? // Relación 1:1 con Pago
}

model ItemPedido {
  id             Int     @id @default(autoincrement())
  cantidad       Int
  nota           String?
  precioUnitario Float

  pedidoId Int
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  platoId Int
  plato   Plato @relation(fields: [platoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([pedidoId, platoId]) // Un plato solo puede estar una vez en el mismo pedido
}

// --- Entidades de Pago y Reserva ---
// Definición de los tipos de métodos soportados
enum PaymentType {
  PAGO_MOVIL
  TRANSFERENCIA
  ZELLE
  EFECTIVO
}

model PaymentMethod {
  id       String      @id @default(uuid())
  type     PaymentType
  isActive Boolean     @default(true)

  // Datos comunes para identificación
  label     String // Ej: "Mi Cuenta Banesco" o "Pago Móvil Principal"
  ownerName String // Nombre del titular
  ownerId   String? // Cédula o RIF del titular

  // Datos específicos para Transferencia / Pago Móvil
  bankName      String? // Nombre del banco (Ej: "Banesco")
  accountNumber String? // Número de cuenta (20 dígitos)
  phoneNumber   String? // Número de teléfono (para Pago Móvil)

  // Datos específicos para Zelle o métodos digitales
  email String? // Correo electrónico

  // Relación con los pagos recibidos
  payments Payment[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id])
  restaurantId Int?
}

model Payment {
  id        Int           @id @default(autoincrement())
  monto     Float
  status    PaymentStatus @default(PENDING)
  fechaHora DateTime      @default(now())

  paymentMethodId String
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  pedidoId Int    @unique // Relación 1:1 con Pedido
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  restaurantId Int? // El pedido tambien pertenece a un restaurante
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REJECTED
}

model Reserva {
  id          Int      @id @default(autoincrement())
  fechaHora   DateTime
  numPersonas Int
  estado      String   @default("Pendiente") // Ej: "Pendiente", "Confirmada", "Cancelada"

  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  mesaId Int
  mesa   Mesa @relation(fields: [mesaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([fechaHora, mesaId]) // Una mesa solo puede estar reservada una vez a una hora específica
}

// --- Entidades de Empleados y Roles ---

model Rol {
  id        Int        @id @default(autoincrement())
  nombre    String     @unique // Ej: "Mesero", "Cocinero", "Administrador"
  empleados Empleado[] // Relación: Un rol tiene muchos empleados
}

model Empleado {
  id            Int      @id @default(autoincrement())
  nombre        String
  apellido      String
  telefono      String?  @unique
  fechaContrato DateTime @default(now())

  rolId Int
  rol   Rol @relation(fields: [rolId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  pedidosTomados Pedido[] // Relación: Un empleado puede tomar muchos pedidos

  // Campo para almacenar el ID de la Imagen Principal.
  // La imagen se gestiona través de la relación polimórfica en la capa de la aplicación.
  mainImageId String?
  shifts      EmpleadoHorario[]

  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model EmpleadoHorario {
  id         String   @id @default(uuid())
  empleadoId Int // Empleado asignado
  startTime  DateTime
  endTime    DateTime
  empleado   Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}
